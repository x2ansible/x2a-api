name: Build & Publish UBI Image with Podman

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Podman and gh CLI
        run: |
          sudo apt-get update
          sudo apt-get -y install podman gh

      - name: Login to GHCR
        env:
          CR_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${CR_PAT}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build image
        run: |
          podman build -t ghcr.io/x2ansible/x2a-api:latest -f Containerfile .

      - name: Push image (public)
        run: |
          podman push ghcr.io/x2ansible/x2a-api:latest

      - name: Make GHCR image public (retry up to 60s)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ORG="x2ansible"
          IMAGE="x2a-api"
          echo "Making ghcr.io/$ORG/$IMAGE public"
          for i in {1..12}; do
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              /orgs/$ORG/packages/container/$IMAGE/visibility \
              -f visibility=public && break || sleep 5
            echo "Retrying PATCH... attempt $i"
          done
